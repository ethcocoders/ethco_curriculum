{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('admin_course_builder') }}">Course Builder</a></li>
            {% if entity_type == 'module' %}
                <li class="breadcrumb-item active" aria-current="page">{{ entity.title }} Content Management</li>
            {% elif entity_type == 'submodule' %}
                <li class="breadcrumb-item"><a href="{{ url_for('admin_module_content_management', module_id=entity.module_id) }}">{{ entity.module.title }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ entity.title }} Content Management</li>
            {% endif %}
        </ol>
    </nav>

    <h1 class="mb-4">{{ entity.title }} Content Management</h1>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    Contained Items
                </div>
                <ul class="list-group list-group-flush">
                    {% if entity_type == 'module' %}
                        {% for submodule in entity.submodules %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-folder"></i> <strong>Submodule:</strong> {{ submodule.title }}
                                    <span class="badge bg-secondary ms-2">Order: {{ submodule.order }}</span>
                                </div>
                                <div>
                                    <a href="{{ url_for('admin_submodule_content_management', submodule_id=submodule.id) }}" class="btn btn-sm btn-info me-2">Manage Content</a>
                                    <a href="{{ url_for('edit_submodule', submodule_id=submodule.id) }}" class="btn btn-sm btn-warning me-2">Edit</a>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteSubmodule({{ submodule.id }}, '{{ submodule.title }}')">Delete</button>
                                </div>
                            </li>
                        {% endfor %}
                    {% elif entity_type == 'submodule' %}
                        {% for item in entity.items %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-file"></i> <strong>{{ item.content_type | capitalize }}:</strong> 
                                    {% if item.content_object %}
                                        {{ item.content_object.title }}
                                    {% else %}
                                        (Content not found)
                                    {% endif %}
                                    <span class="badge bg-secondary ms-2">Order: {{ item.order }}</span>
                                    {% if item.content_path %}
                                        <small class="text-muted ms-2">Path: {{ item.content_path }}</small>
                                    {% endif %}
                                </div>
                                <div>
                                    <a href="#" class="btn btn-sm btn-warning me-2">Edit</a>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteModuleItem({{ item.id }}, '{{ item.content_object.title if item.content_object else "Unknown" }}')">Delete</button>
                                </div>
                            </li>
                        {% endfor %}
                    {% endif %}
                    {% if not entity.submodules and not entity.items %}
                        <li class="list-group-item text-center text-muted">No items in this {{ entity_type }}.</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    Add New Item
                </div>
                <div class="card-body">
                    {% if entity_type == 'module' %}
                        <form action="{{ url_for('admin_manage_submodules', module_id=entity.id) }}" method="POST">
                            <div class="mb-3">
                                <label for="submoduleTitle" class="form-label">New Submodule Title</label>
                                <input type="text" class="form-control" id="submoduleTitle" name="title" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Submodule</button>
                        </form>
                    {% elif entity_type == 'submodule' %}
                        <form action="{{ url_for('add_module_item', submodule_id=entity.id) }}" method="POST">
                            <div class="mb-3">
                                <label for="itemType" class="form-label">Content Type</label>
                                <select class="form-select" id="itemType" name="content_type" required>
                                    <option value="">Select Type</option>
                                    <option value="quiz">Quiz</option>
                                    <option value="lab">Lab</option>
                                    <option value="session">Session</option>
                                    <option value="note">Note (Markdown File)</option>
                                </select>
                            </div>
                            <div class="mb-3" id="contentIdField" style="display: none;">
                                <label for="contentId" class="form-label">Select Content</label>
                                <select class="form-select" id="contentId" name="content_id">
                                    <!-- Options will be loaded dynamically via JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3" id="contentPathField" style="display: none;">
                                <label for="contentPath" class="form-label">Content Path (e.g., static/uploads/curriculum/module/submodule/file.md)</label>
                                <input type="text" class="form-control" id="contentPath" name="content_path">
                            </div>
                            <button type="submit" class="btn btn-primary">Add Module Item</button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const itemTypeSelect = document.getElementById('itemType');
        const contentIdField = document.getElementById('contentIdField');
        const contentIdSelect = document.getElementById('contentId');
        const contentPathField = document.getElementById('contentPathField');
        const contentPathInput = document.getElementById('contentPath');

        if (itemTypeSelect) {
            itemTypeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                
                // Reset visibility and required attributes
                contentIdField.style.display = 'none';
                contentIdSelect.removeAttribute('required');
                contentPathField.style.display = 'none';
                contentPathInput.removeAttribute('required');
                contentIdSelect.innerHTML = ''; // Clear previous options

                if (selectedType === 'quiz' || selectedType === 'lab' || selectedType === 'session') {
                    contentIdField.style.display = 'block';
                    contentIdSelect.setAttribute('required', 'required');
                    fetchContentOptions(selectedType);
                } else if (selectedType === 'note') {
                    contentPathField.style.display = 'block';
                    contentPathInput.setAttribute('required', 'required');
                }
            });
        }

        function fetchContentOptions(type) {
            fetch(`/admin/api/get_content_by_type/${type}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        data.content.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.title;
                            contentIdSelect.appendChild(option);
                        });
                    } else {
                        console.error('Error fetching content:', data.message);
                    }
                })
                .catch(error => console.error('Fetch error:', error));
        }
    });

    function deleteSubmodule(submoduleId, submoduleTitle) {
        if (confirm(`Are you sure you want to delete the submodule "${submoduleTitle}"? This action cannot be undone.`)) {
            fetch(`/admin/submodule/${submoduleId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Include CSRF token if you have one
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    location.reload(); // Reload the page to reflect changes
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the submodule.');
            });
        }
    }

    function deleteModuleItem(moduleItemId, itemTitle) {
        if (confirm(`Are you sure you want to delete the module item "${itemTitle}"? This action cannot be undone.`)) {
            fetch(`/admin/module_item/${moduleItemId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Include CSRF token if you have one
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    location.reload(); // Reload the page to reflect changes
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the module item.');
            });
        }
    }
</script>
{% endblock %}
